
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js">
    import * as tf from "@tensorflow/tfjs";
    // import * as tfa from '@tensorflow/tfjs-layers/dist/addons';
</script>

<html>

<body onload="loadNPVModel(); loadGDP20Model(); loadPopModel()">


    <h1>Input Parameter Values</h1>
    <label for="inputMortality">Mortality rates by age (year shift): <div id="demo1">--</div></label>
    <div class="slidecontainer">
        <input type="range" min=0 max=5 value=0.0 step=0.1 class="slider" id="inputMortality">
    </div>
    <label for="inputProductivity">Productivity rates by age (year shift): <div id="demo2">--</div></label>
    <div class="slidecontainer">
        <input type="range" min=0 max=5 value=0.0 step=0.1 class="slider" id="inputProductivity">
    </div>
    <label for="inputFertility">Fertility rates by age (year shift): <div id="demo3">--</div></label>
    <div class="slidecontainer">
        <input type="range" min=0 max=5 value=0.0 step=0.1 class="slider" id="inputFertility">
    </div>
    <label for="inputR">Discount rate: <div id="demo4">--</div></label>
    <div class="slidecontainer">
        <input type="range" min=0.01 max=0.07 value=0.04 step=0.005 class="slider" id="inputR">
    </div>
    <label for="inputAge">Age of population who will benefit: <div id="demo5">--</div></label>
    <div class="slidecontainer">
        <input type="range" min=40 max=65 value=40 class="slider" id="inputAge">
    </div>
    <label for="inputStartYear">Years until aging treatment enters market: <div id="demo6">--</div></label>
    <div class="slidecontainer">
        <input type="range" min=0 max=20 value=10 class="slider" id="inputStartYear">
    </div>
    <label for="inputNumYears">Years from market entry until max adoption of treatment: <div id="demo7">--</div></label>
    <div class="slidecontainer">
        <input type="range" min=0 max=20 value=10 class="slider" id="inputNumYears">
    </div>

    <h2>Long-term return, Trillions of 2025$ (change in GDP over several decades)</h2>
    <label for="outputNPV">NPV:</label>
    <input type="text" id="outputNPV" name="outputNPV" readonly>
    <h2>Yearly GDP change, Billions of 2025$ (average over 2045-2065)</h2>
    <label for="outputGDP20">GDP:</label>
    <input type="text" id="outputGDP20" name="outputGDP20" readonly>
    <h2>Lived saved by 2050 (millions of people)</h2>
    <label for="outputPop">Pop:</label>
    <input type="text" id="outputPop" name="outputPop" readonly>


</body>

</html>


<script>
    let model;
    // Store normalization parameters
    const inputMeans = [5.1302979e+01, 8.4279661e+00, 1.0377118e+01, 1.9504026e+00, 1.8451481e+00, 6.7474580e-01, 3.5000000e-02];
    const inputStds = [10.563937, 8.102567, 8.245038, 2.1774914, 2.1157672, 0.6330082, 0.01707825];

    // Load the models
    async function loadNPVModel() {
        return tf.loadLayersModel('/tf_model/NPV/model.json');

    }
    async function loadGDP20Model() {
        return tf.loadLayersModel('/tf_model/GDP_20/model.json');

    }
    async function loadPopModel() {
        return tf.loadLayersModel('/tf_model/Pop/model.json');

    }

    // Normalization function
    function normalizeData(tensor, means, stds) {
        return tf.tidy(() => {
            return tensor.sub(means).div(stds);
        });
    }

    // Run the surrogate model
    async function doSurrogate() {
        // Get input value
        npv_model = await loadNPVModel();
        GDP_20_model = await loadGDP20Model();
        pop_model = await loadPopModel();
        // const layer = tf.layers.layerNormalization({axis: -1});
        // model.add(layer);
        // model.compile({optimizer: 'adam',
        //       loss: 'meanSquaredError'});
        // model.add(tf.layers.layerNormalization({axis: -1}));
        const inputR = parseFloat(document.getElementById('inputR').value);
        const inputAge = parseFloat(document.getElementById('inputAge').value);
        const inputStartYear = parseFloat(document.getElementById('inputStartYear').value);
        const inputNumYears = parseFloat(document.getElementById('inputNumYears').value);
        const inputMortality = parseFloat(document.getElementById('inputMortality').value);
        const inputProductivity = parseFloat(document.getElementById('inputProductivity').value);
        const inputFertility = parseFloat(document.getElementById('inputFertility').value);
        // console.log(inputR, inputAge, inputStartYear, inputNumYears, inputMortality, inputFertility, inputProductivity)
        // Below list needs to follow same order as the input list used to train the model
        inputTensor_NPV = tf.tensor2d([inputAge, inputStartYear, inputNumYears, inputMortality, inputProductivity, inputFertility, inputR], [1, 7]);
        inputTensor_GDP_pop = tf.tensor2d([inputAge, inputStartYear, inputNumYears, inputMortality, inputProductivity, inputFertility], [1, 6]);
        // do normalization of inputTensor manually
        // const inputMean = [5.13029661e+01, 8.42796610e+00, 1.03771186e+01, 1.95040254e+00, 1.84514831e+00, 6.74745763e-01, 3.50000000e-0];
        // const inputStd = [10.56393728,  8.10256693,  8.24503868,  2.17749157,  2.11576718,  0.6330083, 0.01707825];
        // inputTensor = inputs.sub(inputMean).div(inputStd);
        // Get prediction with new input

        // Normalize the inputs
        const normalizedInputs_NPV = normalizeData(
            inputTensor_NPV,
            tf.tensor(inputMeans),
            tf.tensor(inputStds)
        );
        const normalizedInputs_GDP_pop = normalizeData(
            inputTensor_GDP_pop,
            tf.tensor(inputMeans.slice(0, -1)),
            tf.tensor(inputStds.slice(0, -1))
        );

        const prediction_NPV = npv_model.predict(normalizedInputs_NPV);
        const prediction_GDP_20 = GDP_20_model.predict(normalizedInputs_GDP_pop);
        const prediction_Pop = pop_model.predict(normalizedInputs_GDP_pop);

        // Clean up tensors
        tf.dispose([inputTensor_NPV, inputTensor_GDP_pop, normalizedInputs_NPV, normalizedInputs_GDP_pop]);

        // Display the prediction in the output box
        // console.log(prediction.arraySync()[0]);
        document.getElementById("outputNPV").value = Math.round(prediction_NPV.arraySync()[0][0] * 10) / 10; // The arraySync() method returns the value of the tensor as a nested array.
        document.getElementById("outputGDP20").value = Math.round(prediction_GDP_20.arraySync()[0][0]); // The arraySync() method returns the value of the tensor as a nested array.
        document.getElementById("outputPop").value = Math.round(prediction_Pop.arraySync()[0][0] * 10) / 10; // The arraySync() method returns the value of the tensor as a nested array.
    }

        var slider1 = document.getElementById("inputMortality");
        var output1 = document.getElementById("demo1");
        var slider2 = document.getElementById("inputProductivity");
        var output2 = document.getElementById("demo2");
        var slider3 = document.getElementById("inputFertility");
        var output3 = document.getElementById("demo3");
        var slider4 = document.getElementById("inputR");
        var output4 = document.getElementById("demo4");
        var slider5 = document.getElementById("inputAge");
        var output5 = document.getElementById("demo5");
        var slider6 = document.getElementById("inputStartYear");
        var output6 = document.getElementById("demo6");
        var slider7 = document.getElementById("inputNumYears");
        var output7 = document.getElementById("demo7");


        // Update the current slider value (each time you drag the slider handle)
        slider1.oninput = function() {
            output1.innerHTML = slider1.value; // Display the default slider value
            doSurrogate()  // Compute the result from the surrogate model
        }
        slider2.oninput = function() {
            output2.innerHTML = slider2.value; // Display the default slider value
            doSurrogate()  // Compute the result from the surrogate model
        }
        slider3.oninput = function() {
            output3.innerHTML = slider3.value; // Display the default slider value
            doSurrogate()  // Compute the result from the surrogate model
        }
        slider4.oninput = function() {
            output4.innerHTML = slider4.value; // Display the default slider value
            doSurrogate()  // Compute the result from the surrogate model
        }
        slider5.oninput = function() {
            output5.innerHTML = slider5.value; // Display the default slider value
            doSurrogate()  // Compute the result from the surrogate model
        }
        slider6.oninput = function() {
            output6.innerHTML = slider6.value; // Display the default slider value
            doSurrogate()  // Compute the result from the surrogate model
        }
        slider7.oninput = function() {
            output7.innerHTML = slider7.value; // Display the default slider value
            doSurrogate()  // Compute the result from the surrogate model
        }

    //

</script>